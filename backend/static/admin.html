<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin | Kairix</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: #121212; color: white; }

        .header { background: rgba(255,255,255,0.05); padding: 20px 40px; border-bottom: 1px solid rgba(255,90,90,0.2); display: flex; justify-content: space-between; align-items: center; }
        .header img { height: 60px; }
        .logout { background: linear-gradient(135deg, #FF5A5A, #9A0000); padding: 10px 20px; border-radius: 8px; border: none; color: white; cursor: pointer; font-weight: 600; }

        .tabs { display: flex; gap: 10px; padding: 20px 40px; background: rgba(0,0,0,0.3); }
        .tab { padding: 12px 30px; background: transparent; border: none; color: rgba(255,255,255,0.6); cursor: pointer; border-radius: 8px; font-weight: 600; transition: all 0.3s; }
        .tab.active { background: linear-gradient(135deg, #FF5A5A, #9A0000); color: white; }

        /* Sub-tabs */
        .sub-tabs { display: flex; gap: 8px; margin-bottom: 25px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 10px; }
        .sub-tab { padding: 10px 20px; background: transparent; border: none; color: rgba(255,255,255,0.5); cursor: pointer; border-radius: 6px; font-weight: 500; font-size: 13px; transition: all 0.3s; }
        .sub-tab:hover { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.8); }
        .sub-tab.active { background: rgba(255,90,90,0.3); color: white; border: 1px solid rgba(255,90,90,0.5); }
        .sub-tab-content { display: none; }
        .sub-tab-content.active { display: block; }

        .content { padding: 40px; max-width: 95%; margin: 0 auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat { background: rgba(255,255,255,0.05); padding: 25px; border-radius: 15px; border: 1px solid rgba(255,90,90,0.2); }
        .stat-value { font-size: 36px; font-weight: 800; background: linear-gradient(135deg, #FF5A5A, #9A0000); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .stat-label { color: rgba(255,255,255,0.7); margin-top: 10px; font-size: 14px; }

        .graficos { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 30px; }
        .grafico-card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,90,90,0.2); }
        .grafico-card h4 { margin-bottom: 15px; color: #FF5A5A; }

        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-primary { background: linear-gradient(135deg, #FF5A5A, #9A0000); padding: 12px 24px; border-radius: 8px; border: none; color: white; cursor: pointer; font-weight: 600; font-size: 14px; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background: rgba(255,255,255,0.1); padding: 12px 24px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); color: white; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s; }
        .btn-secondary:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,90,90,0.5); }

        .table-container { overflow-x: auto; margin-bottom: 20px; }
        table { width: 100%; min-width: 1400px; border-collapse: collapse; background: rgba(255,255,255,0.05); border-radius: 15px; overflow: hidden; }
        #table-planos { min-width: auto; } /* Remover min-width para tabela de planos */
        #table-clientes { min-width: auto; } /* Remover min-width para tabela de clientes */
        th { background: rgba(255,90,90,0.2); padding: 12px 10px; text-align: left; font-weight: 600; white-space: nowrap; font-size: 13px; }
        td { padding: 12px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); white-space: nowrap; font-size: 13px; }
        td:last-child { white-space: normal; min-width: 350px; }
        #table-clientes td:last-child { min-width: auto; } /* Remover min-width da √∫ltima coluna de clientes */
        #table-planos td:last-child { min-width: auto; } /* Remover min-width da √∫ltima coluna de planos */
        tr:hover { background: rgba(255,255,255,0.02); }

        .btn-action { padding: 6px 12px; margin: 2px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s; }
        .btn-view { background: #4CAF50; color: white; }
        .btn-edit { background: #2196F3; color: white; }
        .btn-toggle { background: #FF9800; color: white; }
        .btn-delete { background: #f44336; color: white; }
        .btn-action:hover { opacity: 0.8; transform: translateY(-1px); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: #1e1e1e; padding: 30px; border-radius: 15px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; border: 1px solid rgba(255,90,90,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { font-size: 24px; }
        .modal-close { background: none; border: none; color: white; font-size: 28px; cursor: pointer; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: rgba(255,255,255,0.8); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; font-family: 'Poppins', sans-serif; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #FF5A5A; }

        .pedidos-list { max-height: 400px; overflow-y: auto; }
        .pedido-item { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 3px solid #FF5A5A; }
        .pedido-item h4 { margin-bottom: 8px; color: #FF5A5A; }
        .pedido-item p { margin: 5px 0; font-size: 14px; color: rgba(255,255,255,0.7); }
    </style>
</head>
<body>
    <div class="header">
        <img src="/logo.png" alt="Kairix">
        <button class="logout" onclick="logout()">Sair</button>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('dashboard')">Dashboard</button>
        <button class="tab" onclick="switchTab('clientes')">Clientes</button>
        <button class="tab" onclick="switchTab('planos')">Planos</button>
        <button class="tab" onclick="switchTab('configuracoes')">‚öôÔ∏è Configura√ß√µes</button>
    </div>

    <div class="content">
        <!-- DASHBOARD -->
        <div id="dashboard" class="tab-content active">
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="total-clientes">-</div>
                    <div class="stat-label">Total Clientes</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="clientes-ativos" style="color: #00D95F;">-</div>
                    <div class="stat-label">‚úÖ Clientes Ativos</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="clientes-inativos" style="color: #FF5A5A;">-</div>
                    <div class="stat-label">‚ùå Clientes Inativos</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="aguardando-pagamento" style="color: #FF9800;">-</div>
                    <div class="stat-label">‚è≥ Aguardando Pagamento</div>
                </div>
            </div>

            <div class="stats" style="margin-top: 20px;">
                <div class="stat">
                    <div class="stat-value" id="total-pedidos">-</div>
                    <div class="stat-label">Total Pedidos</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="pedidos-concluidos">-</div>
                    <div class="stat-label">Conclu√≠dos</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="receita-total">-</div>
                    <div class="stat-label">Receita Total</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="total-conversas">-</div>
                    <div class="stat-label">Total Conversas</div>
                </div>
            </div>

            <!-- ALERTAS DE VENCIMENTO -->
            <div id="alertas-vencimento" style="margin: 30px 0; display: none;">
                <h3 style="margin-bottom: 15px; color: #FF9800;">‚ö†Ô∏è Alertas de Vencimento</h3>
                <div id="lista-alertas" style="display: grid; gap: 15px;"></div>
            </div>

            <h3 style="margin: 30px 0 15px;">√öltimos Pedidos</h3>
            <table id="ultimos-pedidos">
                <thead><tr><th>ID</th><th>Cliente</th><th>Plano</th><th>Valor</th><th>Status</th></tr></thead>
                <tbody><tr><td colspan="5" style="text-align:center;">Carregando...</td></tr></tbody>
            </table>

            <!-- GR√ÅFICOS -->
            <h3 style="margin: 30px 0 15px;">üìä An√°lises e M√©tricas</h3>
            <div class="graficos">
                <div class="grafico-card">
                    <h4>üí¨ Conversas Di√°rias (√öltimos 7 dias)</h4>
                    <canvas id="grafico-conversas"></canvas>
                </div>
                <div class="grafico-card">
                    <h4>üì® Mensagens Di√°rias (√öltimos 7 dias)</h4>
                    <canvas id="grafico-mensagens"></canvas>
                </div>
                <div class="grafico-card">
                    <h4>üìà Novos Clientes (√öltimos 30 dias)</h4>
                    <canvas id="grafico-clientes"></canvas>
                </div>
                <div class="grafico-card">
                    <h4>üí∞ Receita Mensal (√öltimos 6 meses)</h4>
                    <canvas id="grafico-receita"></canvas>
                </div>
            </div>
        </div>

        <!-- CLIENTES -->
        <div id="clientes" class="tab-content">
            <div class="section-header">
                <h2>Clientes</h2>
            </div>
            <div class="table-container">
                <table id="table-clientes">
                    <thead><tr><th>ID</th><th>Nome</th><th style="text-align:center;">Email</th><th style="text-align:center;">Telefone</th><th style="text-align:center;">Status</th><th style="text-align:center;">Plano Atual</th><th style="text-align:center;">Data Fim</th><th style="text-align:center;">A√ß√µes</th></tr></thead>
                    <tbody><tr><td colspan="8" style="text-align:center;">Carregando...</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- PLANOS -->
        <div id="planos" class="tab-content">
            <div class="section-header">
                <h2>Planos</h2>
                <button class="btn-primary" onclick="novoPlano()">+ Novo Plano</button>
            </div>
            <div class="table-container">
                <table id="table-planos">
                    <thead><tr><th style="text-align:center;">ID</th><th>Nome</th><th style="text-align:center;">Tipo</th><th style="text-align:center;">Per√≠odo</th><th style="text-align:center;">Pre√ßo</th><th style="text-align:center;">Link Pagamento</th><th style="text-align:center;">A√ß√µes</th></tr></thead>
                    <tbody><tr><td colspan="7" style="text-align:center;">Carregando...</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- CONFIGURA√á√ïES DO SISTEMA -->
        <div id="configuracoes" class="tab-content">
            <div class="section-header">
                <h2>‚öôÔ∏è Configura√ß√µes do Sistema</h2>
            </div>

            <!-- Sub-Tabs para Configura√ß√µes -->
            <div class="sub-tabs">
                <button class="sub-tab active" onclick="switchSubTab('evolution-api')">üîå Evolution API</button>
                <button class="sub-tab" onclick="switchSubTab('inteligencia-artificial')">ü§ñ Intelig√™ncia Artificial</button>
                <button class="sub-tab" onclick="switchSubTab('base-conhecimento')">üóÑÔ∏è Base de Conhecimento</button>
            </div>

            <form id="form-configuracoes" onsubmit="salvarConfiguracoes(event)" style="max-width: 900px;">

                <!-- Evolution API Sub-Tab -->
                <div id="evolution-api" class="sub-tab-content active">
                    <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 15px; border: 1px solid rgba(255,90,90,0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: #FF5A5A;">üîå Evolution API (Configura√ß√µes Globais)</h3>
                            <div style="display: flex; gap: 8px;">
                                <button type="button" class="btn-secondary" onclick="carregarConfiguracoes()" style="padding: 8px 16px; font-size: 13px;">üîÑ Recarregar</button>
                                <button type="button" class="btn-secondary" onclick="testarEvolution()" style="padding: 8px 16px; font-size: 13px;">üîç Testar Conex√£o</button>
                            </div>
                        </div>
                        <p style="font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 15px;">
                            ‚ÑπÔ∏è Uma inst√¢ncia √∫nica ser√° criada automaticamente para cada cliente ap√≥s o pagamento.
                        </p>
                        <div style="display: grid; gap: 15px;">
                            <div class="form-group">
                                <label>URL da API</label>
                                <input type="text" id="evolution_api_url" placeholder="http://localhost:8055">
                                <small>URL base do servidor Evolution API</small>
                            </div>
                            <div class="form-group">
                                <label>API Key Global</label>
                                <input type="password" id="evolution_api_key" placeholder="Sua chave de API global">
                                <small>Chave de autentica√ß√£o para gerenciar todas as inst√¢ncias</small>
                            </div>
                        </div>
                        <div id="evolution-test-result" style="margin-top: 10px;"></div>
                    </div>
                </div>

                <!-- Intelig√™ncia Artificial Sub-Tab -->
                <div id="inteligencia-artificial" class="sub-tab-content">
                    <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 15px; border: 1px solid rgba(255,90,90,0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: #FF5A5A;">ü§ñ Ollama (Intelig√™ncia Artificial Local)</h3>
                            <div style="display: flex; gap: 8px;">
                                <button type="button" class="btn-secondary" onclick="carregarConfiguracoes()" style="padding: 8px 16px; font-size: 13px;">üîÑ Recarregar</button>
                                <button type="button" class="btn-secondary" onclick="testarOllama()" style="padding: 8px 16px; font-size: 13px;">üîç Testar Conex√£o</button>
                            </div>
                        </div>
                        <p style="font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 15px;">
                            ‚ÑπÔ∏è Configure o servidor Ollama para processamento de IA local.
                        </p>
                        <div style="display: grid; gap: 15px;">
                            <div class="form-group">
                                <label>URL do Ollama</label>
                                <input type="text" id="ollama_url" placeholder="http://localhost:11434">
                                <small>Endere√ßo do servidor Ollama</small>
                            </div>
                            <div class="form-group">
                                <label>Modelo para Chat</label>
                                <input type="text" id="ollama_model" placeholder="llama3">
                                <small>Nome do modelo para conversa√ß√£o (ex: llama3, mistral, phi3)</small>
                            </div>
                            <div class="form-group">
                                <label>Modelo para Embeddings (Vetoriza√ß√£o)</label>
                                <input type="text" id="ollama_embeddings_model" placeholder="nomic-embed-text">
                                <small>Modelo especializado em embeddings (ex: nomic-embed-text, mxbai-embed-large, all-minilm)</small>
                            </div>
                        </div>

                        <div style="border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0; padding-top: 20px;">
                            <h4 style="color: #FF5A5A; margin: 0 0 15px;">‚öôÔ∏è Configura√ß√µes RAG (Recupera√ß√£o de Contexto)</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label>Tamanho do Chunk</label>
                                    <input type="number" id="rag_chunk_size" placeholder="1500" min="100" max="5000">
                                    <small>Tamanho de cada fragmento de texto (padr√£o: 1500 caracteres)</small>
                                </div>
                                <div class="form-group">
                                    <label>Sobreposi√ß√£o de Chunks</label>
                                    <input type="number" id="rag_chunk_overlap" placeholder="200" min="0" max="1000">
                                    <small>Quantos caracteres sobrepor entre chunks (padr√£o: 200)</small>
                                </div>
                                <div class="form-group">
                                    <label>Limite de Busca</label>
                                    <input type="number" id="rag_search_limit" placeholder="5" min="1" max="20">
                                    <small>Quantos chunks retornar na busca (padr√£o: 5)</small>
                                </div>
                                <div class="form-group">
                                    <label>M√°x. Tokens Resposta</label>
                                    <input type="number" id="rag_num_predict" placeholder="800" min="100" max="4000">
                                    <small>Limite de tokens para a resposta da IA (padr√£o: 800)</small>
                                </div>
                                <div class="form-group">
                                    <label>Temperature</label>
                                    <input type="number" id="rag_temperature" placeholder="0.6" min="0" max="2" step="0.1">
                                    <small>Criatividade da IA (0=conservador, 2=criativo, padr√£o: 0.6)</small>
                                </div>
                                <div class="form-group">
                                    <label>Top P</label>
                                    <input type="number" id="rag_top_p" placeholder="0.9" min="0" max="1" step="0.1">
                                    <small>Diversidade das respostas (padr√£o: 0.9)</small>
                                </div>
                            </div>
                        </div>

                        <div id="ollama-test-result" style="margin-top: 10px;"></div>
                    </div>
                </div>

                <!-- Base de Conhecimento Sub-Tab -->
                <div id="base-conhecimento" class="sub-tab-content">
                    <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 15px; border: 1px solid rgba(255,90,90,0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: #FF5A5A;">üóÑÔ∏è Qdrant (Base de Conhecimento)</h3>
                            <div style="display: flex; gap: 8px;">
                                <button type="button" class="btn-secondary" onclick="carregarConfiguracoes()" style="padding: 8px 16px; font-size: 13px;">üîÑ Recarregar</button>
                                <button type="button" class="btn-secondary" onclick="testarQdrant()" style="padding: 8px 16px; font-size: 13px;">üîç Testar Conex√£o</button>
                            </div>
                        </div>
                        <p style="font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 15px;">
                            ‚ÑπÔ∏è Banco de dados vetorial para armazenar base de conhecimento.
                        </p>
                        <div style="display: grid; gap: 15px;">
                            <div class="form-group">
                                <label>URL</label>
                                <input type="text" id="qdrant_url" placeholder="http://localhost:6333">
                                <small>Endere√ßo do servidor Qdrant</small>
                            </div>
                            <div class="form-group">
                                <label>API Key (opcional)</label>
                                <input type="password" id="qdrant_api_key" placeholder="Deixe em branco se n√£o usar">
                                <small>Chave de autentica√ß√£o (se configurada no Qdrant)</small>
                            </div>
                            <div class="form-group">
                                <label>Nome da Cole√ß√£o</label>
                                <input type="text" id="qdrant_collection" placeholder="kairix">
                                <small>Nome da cole√ß√£o onde os vetores ser√£o armazenados</small>
                            </div>
                        </div>
                        <div id="qdrant-test-result" style="margin-top: 10px;"></div>
                    </div>
                </div>

                <div style="margin-top: 25px;">
                    <button type="submit" class="btn-primary">üíæ Salvar Todas as Configura√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL VER DADOS CLIENTE -->
    <div id="modal-ver-cliente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Dados do Cliente</h3>
                <button class="modal-close" onclick="closeModal('modal-ver-cliente')">&times;</button>
            </div>
            <div id="dados-cliente"></div>
        </div>
    </div>

    <!-- MODAL VER PEDIDOS -->
    <div id="modal-pedidos-cliente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Pedidos do Cliente</h3>
                <button class="modal-close" onclick="closeModal('modal-pedidos-cliente')">&times;</button>
            </div>
            <div id="pedidos-cliente" class="pedidos-list"></div>
        </div>
    </div>

    <!-- MODAL EDITAR CLIENTE -->
    <div id="modal-editar-cliente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Cliente</h3>
                <button class="modal-close" onclick="closeModal('modal-editar-cliente')">&times;</button>
            </div>
            <form id="form-editar-cliente" onsubmit="salvarCliente(event)">
                <input type="hidden" id="edit-cliente-id">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label>Nome *</label>
                        <input type="text" id="edit-cliente-nome" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="edit-cliente-email" required>
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="text" id="edit-cliente-telefone">
                    </div>
                    <div class="form-group">
                        <label>WhatsApp</label>
                        <input type="text" id="edit-cliente-whatsapp">
                    </div>
                    <div class="form-group">
                        <label>CPF/CNPJ</label>
                        <input type="text" id="edit-cliente-cpf">
                    </div>
                    <div class="form-group">
                        <label>Nome da Empresa</label>
                        <input type="text" id="edit-cliente-empresa">
                    </div>
                </div>
                <div class="form-group">
                    <label>Endere√ßo</label>
                    <input type="text" id="edit-cliente-endereco">
                </div>
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label>Cidade</label>
                        <input type="text" id="edit-cliente-cidade">
                    </div>
                    <div class="form-group">
                        <label>Estado</label>
                        <input type="text" id="edit-cliente-estado" maxlength="2">
                    </div>
                    <div class="form-group">
                        <label>CEP</label>
                        <input type="text" id="edit-cliente-cep">
                    </div>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">Salvar</button>
            </form>
        </div>
    </div>

    <!-- MODAL EDITAR/CRIAR PLANO -->
    <div id="modal-plano" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-plano-title">Novo Plano</h3>
                <button class="modal-close" onclick="closeModal('modal-plano')">&times;</button>
            </div>
            <form id="form-plano" onsubmit="salvarPlano(event)">
                <input type="hidden" id="plano-id">
                <div class="form-group">
                    <label>Nome</label>
                    <input type="text" id="plano-nome" required>
                </div>
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="plano-tipo" required>
                        <option value="agente_normal">Agente Normal</option>
                        <option value="agente_ia">Agente IA</option>
                        <option value="agente_financeiro">Agente Financeiro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Per√≠odo</label>
                    <select id="plano-periodo" required>
                        <option value="mensal">Mensal</option>
                        <option value="semestral">Semestral</option>
                        <option value="anual">Anual</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Pre√ßo (R$)</label>
                    <input type="number" step="0.01" id="plano-preco" required>
                </div>
                <div class="form-group">
                    <label>Link de Pagamento</label>
                    <input type="url" id="plano-link">
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <textarea id="plano-descricao" rows="3"></textarea>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Salvar</button>
            </form>
        </div>
    </div>

    <script>
        // Verificar autentica√ß√£o de admin e limpar sess√£o de cliente
        if (localStorage.getItem('admin_logged') !== 'true') {
            window.location.href = '/admin/login';
        }

        // Limpar qualquer sess√£o de cliente que possa existir
        localStorage.removeItem('client_logged');
        localStorage.removeItem('client_id');
        localStorage.removeItem('client_nome');
        localStorage.removeItem('client_email');
        localStorage.removeItem('client_ativo');

        // ========== UTILS ==========
        function formatMoney(value) {
            return value.toFixed(2).replace(".", ",").replace('.', ',');
        }

        // ========== DASHBOARD ==========
        let graficos = {};

        async function loadDashboard() {
            const res = await fetch('/api/admin/dashboard');
            const data = await res.json();

            // Cards principais
            document.getElementById('total-clientes').textContent = data.total_clientes;
            document.getElementById('clientes-ativos').textContent = data.clientes_ativos || 0;
            document.getElementById('clientes-inativos').textContent = data.clientes_inativos || 0;
            document.getElementById('aguardando-pagamento').textContent = data.aguardando_pagamento || 0;
            document.getElementById('total-pedidos').textContent = data.total_pedidos;
            document.getElementById('pedidos-concluidos').textContent = data.pedidos_concluidos;
            document.getElementById('receita-total').textContent = 'R$ ' + formatMoney(data.receita_total);
            document.getElementById('total-conversas').textContent = data.total_conversas || 0;

            // √öltimos pedidos
            const tbody = document.querySelector('#ultimos-pedidos tbody');
            tbody.innerHTML = data.ultimos_pedidos.map(p => `
                <tr>
                    <td>#${p.id}</td>
                    <td>${p.cliente?.nome || '-'}</td>
                    <td>${p.plano?.nome || '-'}</td>
                    <td>R$ ${p.total.toFixed(2).replace(".", ",")}</td>
                    <td>${p.cliente?.ativo ? '‚úÖ Ativo' : '‚ùå Inativo'}</td>
                </tr>
            `).join('');

            // Carregar gr√°ficos
            carregarGraficos();
        }

        async function carregarGraficos() {
            try {
                const res = await fetch('/api/admin/metricas-graficos');
                const data = await res.json();

                // Gr√°fico de Conversas Di√°rias
                if (graficos.conversas) graficos.conversas.destroy();
                const ctxConversas = document.getElementById('grafico-conversas').getContext('2d');
                graficos.conversas = new Chart(ctxConversas, {
                    type: 'line',
                    data: {
                        labels: data.conversas.labels || [],
                        datasets: [{
                            label: 'Conversas',
                            data: data.conversas.data || [],
                            borderColor: '#FF5A5A',
                            backgroundColor: 'rgba(255, 90, 90, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                            x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                        }
                    }
                });

                // Gr√°fico de Mensagens Di√°rias
                if (graficos.mensagens) graficos.mensagens.destroy();
                const ctxMensagens = document.getElementById('grafico-mensagens').getContext('2d');
                graficos.mensagens = new Chart(ctxMensagens, {
                    type: 'bar',
                    data: {
                        labels: data.mensagens.labels || [],
                        datasets: [{
                            label: 'Mensagens',
                            data: data.mensagens.data || [],
                            backgroundColor: 'rgba(0, 217, 95, 0.6)',
                            borderColor: '#00D95F',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                            x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                        }
                    }
                });

                // Gr√°fico de Novos Clientes
                if (graficos.clientes) graficos.clientes.destroy();
                const ctxClientes = document.getElementById('grafico-clientes').getContext('2d');
                graficos.clientes = new Chart(ctxClientes, {
                    type: 'line',
                    data: {
                        labels: data.novos_clientes.labels || [],
                        datasets: [{
                            label: 'Novos Clientes',
                            data: data.novos_clientes.data || [],
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                            x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                        }
                    }
                });

                // Gr√°fico de Receita Mensal
                if (graficos.receita) graficos.receita.destroy();
                const ctxReceita = document.getElementById('grafico-receita').getContext('2d');
                graficos.receita = new Chart(ctxReceita, {
                    type: 'bar',
                    data: {
                        labels: data.receita_mensal.labels || [],
                        datasets: [{
                            label: 'Receita (R$)',
                            data: data.receita_mensal.data || [],
                            backgroundColor: 'rgba(255, 152, 0, 0.6)',
                            borderColor: '#FF9800',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                            x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                        }
                    }
                });
            } catch (err) {
                console.error('Erro ao carregar gr√°ficos:', err);
            }
        }

        // ========== CLIENTES ==========
        async function loadClientes() {
            const res = await fetch('/api/admin/clientes');
            const data = await res.json();

            const tbody = document.querySelector('#table-clientes tbody');
            tbody.innerHTML = data.map(c => {
                // Formatar plano com per√≠odo
                let planoTexto = c.plano_atual || '-';
                if (c.plano_atual && c.plano_periodo) {
                    const meses = c.plano_periodo === 'MENSAL' ? '1 m√™s' :
                                  c.plano_periodo === 'TRIMESTRAL' ? '3 meses' :
                                  c.plano_periodo === 'SEMESTRAL' ? '6 meses' : '12 meses';
                    planoTexto = `${c.plano_atual}<br><small>(${meses})</small>`;
                }

                // Formatar data de validade
                let dataFim = '-';
                if (c.data_validade) {
                    const data = new Date(c.data_validade);
                    dataFim = data.toLocaleDateString('pt-BR');
                }

                return `
                <tr>
                    <td>${c.id}</td>
                    <td>${c.nome}</td>
                    <td style="text-align:center;">${c.email}</td>
                    <td style="text-align:center;">${c.telefone || '-'}</td>
                    <td style="text-align:center;">${c.ativo ? '‚úÖ Ativo' : '‚ùå Inativo'}</td>
                    <td style="text-align:center;">${planoTexto}</td>
                    <td style="text-align:center;">${dataFim}</td>
                    <td style="text-align:center;">
                        <button class="btn-action btn-view" onclick="verPedidosCliente(${c.id}, '${c.nome}')">Ver Planos</button>
                        <button class="btn-action btn-view" onclick="verDadosCliente(${c.id})">Ver Dados</button>
                        <button class="btn-action btn-edit" onclick="editarCliente(${c.id})">Editar</button>
                        <button class="btn-action btn-toggle" onclick="toggleCliente(${c.id}, ${c.ativo})">${c.ativo ? 'Desativar' : 'Ativar'}</button>
                        <button class="btn-action btn-delete" onclick="excluirCliente(${c.id}, '${c.nome}')">Excluir</button>
                    </td>
                </tr>`;
            }).join('');
        }

        async function verDadosCliente(id) {
            const res = await fetch(`/api/admin/clientes/${id}`);
            const data = await res.json();
            const c = data.cliente;

            document.getElementById('dados-cliente').innerHTML = `
                <div style="background: rgba(255,90,90,0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #FF5A5A;">
                    <div style="display: grid; grid-template-columns: 80px 1fr; gap: 12px; align-items: center;">
                        <div style="font-size: 48px; text-align: center;">üë§</div>
                        <div>
                            <h2 style="margin: 0 0 5px 0; font-size: 24px;">${c.nome}</h2>
                            <p style="margin: 0; color: rgba(255,255,255,0.7); font-size: 14px;">${c.ativo ? '‚úÖ Ativo' : '‚ùå Inativo'}</p>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px;">
                        <label style="color: rgba(255,255,255,0.6); font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Email</label>
                        <p style="margin: 8px 0 0; font-size: 15px;">${c.email}</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px;">
                        <label style="color: rgba(255,255,255,0.6); font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Telefone</label>
                        <p style="margin: 8px 0 0; font-size: 15px;">${c.telefone || '-'}</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px;">
                        <label style="color: rgba(255,255,255,0.6); font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">WhatsApp</label>
                        <p style="margin: 8px 0 0; font-size: 15px;">${c.whatsapp || '-'}</p>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px;">
                        <label style="color: rgba(255,255,255,0.6); font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">CPF/CNPJ</label>
                        <p style="margin: 8px 0 0; font-size: 15px;">${c.cpf_cnpj || '-'}</p>
                    </div>
                </div>

                ${c.nome_empresa ? `
                <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; margin-top: 20px;">
                    <label style="color: rgba(255,255,255,0.6); font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Empresa</label>
                    <p style="margin: 8px 0 0; font-size: 15px;">${c.nome_empresa}</p>
                </div>
                ` : ''}

                ${c.endereco || c.cidade ? `
                <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; margin-top: 20px;">
                    <label style="color: rgba(255,255,255,0.6); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 8px;">Endere√ßo</label>
                    ${c.endereco ? `<p style="margin: 0 0 5px; font-size: 15px;">${c.endereco}</p>` : ''}
                    ${c.cidade ? `<p style="margin: 0; font-size: 14px; color: rgba(255,255,255,0.7);">${c.cidade}${c.estado ? ` - ${c.estado}` : ''}${c.cep ? ` | CEP: ${c.cep}` : ''}</p>` : ''}
                </div>
                ` : ''}

                <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 10px; margin-top: 20px; text-align: center;">
                    <label style="color: rgba(255,255,255,0.6); font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Cadastrado em</label>
                    <p style="margin: 8px 0 0; font-size: 14px;">${new Date(c.criado_em).toLocaleString('pt-BR')}</p>
                </div>
            `;
            openModal('modal-ver-cliente');
        }

        async function verPedidosCliente(id, nome) {
            const res = await fetch(`/api/admin/clientes/${id}/pedidos`);
            const pedidos = await res.json();

            const container = document.getElementById('pedidos-cliente');
            if (pedidos.length === 0) {
                container.innerHTML = '<p style="text-align:center; color: rgba(255,255,255,0.5);">Nenhum pedido encontrado</p>';
            } else {
                const hoje = new Date();
                container.innerHTML = pedidos.map(p => {
                    const dataValidade = p.data_validade ? new Date(p.data_validade) : null;
                    const diasRestantes = dataValidade ? Math.ceil((dataValidade - hoje) / (1000 * 60 * 60 * 24)) : null;
                    const statusVencimento = diasRestantes !== null ?
                        (diasRestantes < 0 ? 'üî¥ Vencido' :
                         diasRestantes <= 7 ? 'üü° Vence em breve' :
                         'üü¢ Ativo') : '';

                    return `
                    <div class="pedido-item" style="background: linear-gradient(135deg, rgba(255,90,90,0.1), rgba(154,0,0,0.05)); border-left: 4px solid ${diasRestantes < 0 ? '#f44336' : diasRestantes <= 7 ? '#FF9800' : '#4CAF50'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h4 style="font-size: 20px; color: #FF5A5A; margin-bottom: 5px;">üì¶ ${p.plano?.nome || 'Sem plano'}</h4>
                                <p style="color: rgba(255,255,255,0.6); font-size: 13px;">${p.plano?.tipo || '-'} ‚Ä¢ ${p.plano?.periodo || '-'}</p>
                            </div>
                            <div style="text-align: right;">
                                <p style="font-size: 24px; font-weight: 700; color: #00D95F; margin: 0;">R$ ${formatMoney(p.total)}</p>
                                <p style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 3px;">Pedido #${p.id}</p>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px;">
                            <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;">
                                <p style="font-size: 11px; color: rgba(255,255,255,0.6); margin: 0;">Status</p>
                                <p style="font-size: 13px; font-weight: 600; margin: 5px 0 0;">${p.status}</p>
                            </div>
                            ${dataValidade ? `
                            <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;">
                                <p style="font-size: 11px; color: rgba(255,255,255,0.6); margin: 0;">Validade</p>
                                <p style="font-size: 13px; font-weight: 600; margin: 5px 0 0;">${statusVencimento} ${dataValidade.toLocaleDateString('pt-BR')}</p>
                                ${diasRestantes > 0 ? `<p style="font-size: 11px; color: rgba(255,255,255,0.5); margin: 3px 0 0;">${diasRestantes} dias restantes</p>` : ''}
                            </div>
                            ` : ''}
                        </div>

                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <p style="font-size: 12px; color: rgba(255,255,255,0.5);"><strong>Cadastrado:</strong> ${new Date(p.criado_em).toLocaleString('pt-BR')}</p>
                            ${p.data_pagamento ? `<p style="font-size: 12px; color: rgba(255,255,255,0.5);"><strong>Pago:</strong> ${new Date(p.data_pagamento).toLocaleString('pt-BR')}</p>` : ''}
                        </div>
                    </div>
                `}).join('');
            }
            openModal('modal-pedidos-cliente');
        }

        async function editarCliente(id) {
            const res = await fetch(`/api/admin/clientes/${id}`);
            const data = await res.json();
            const c = data.cliente;

            document.getElementById('edit-cliente-id').value = c.id;
            document.getElementById('edit-cliente-nome').value = c.nome;
            document.getElementById('edit-cliente-email').value = c.email;
            document.getElementById('edit-cliente-telefone').value = c.telefone || '';
            document.getElementById('edit-cliente-whatsapp').value = c.whatsapp || '';
            document.getElementById('edit-cliente-cpf').value = c.cpf_cnpj || '';
            document.getElementById('edit-cliente-empresa').value = c.nome_empresa || '';
            document.getElementById('edit-cliente-endereco').value = c.endereco || '';
            document.getElementById('edit-cliente-cidade').value = c.cidade || '';
            document.getElementById('edit-cliente-estado').value = c.estado || '';
            document.getElementById('edit-cliente-cep').value = c.cep || '';
            openModal('modal-editar-cliente');
        }

        async function salvarCliente(e) {
            e.preventDefault();
            const id = document.getElementById('edit-cliente-id').value;
            const data = {
                nome: document.getElementById('edit-cliente-nome').value,
                email: document.getElementById('edit-cliente-email').value,
                telefone: document.getElementById('edit-cliente-telefone').value,
                whatsapp: document.getElementById('edit-cliente-whatsapp').value,
                cpf_cnpj: document.getElementById('edit-cliente-cpf').value,
                nome_empresa: document.getElementById('edit-cliente-empresa').value,
                endereco: document.getElementById('edit-cliente-endereco').value,
                cidade: document.getElementById('edit-cliente-cidade').value,
                estado: document.getElementById('edit-cliente-estado').value,
                cep: document.getElementById('edit-cliente-cep').value
            };

            const res = await fetch(`/api/admin/clientes/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            if (res.ok) {
                alert('Cliente atualizado com sucesso!');
                closeModal('modal-editar-cliente');
                loadClientes();
            } else {
                alert('Erro ao atualizar cliente');
            }
        }

        async function toggleCliente(id, ativo) {
            const novoStatus = !ativo;
            const acao = novoStatus ? 'ativar' : 'desativar';

            if (!confirm(`Tem certeza que deseja ${acao} este cliente?`)) return;

            const res = await fetch(`/api/admin/clientes/${id}/toggle`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ativo: novoStatus})
            });

            if (res.ok) {
                alert(`Cliente ${novoStatus ? 'ativado' : 'desativado'} com sucesso!`);
                loadClientes();
            } else {
                alert('Erro ao alterar status do cliente');
            }
        }

        async function excluirCliente(id, nome) {
            if (!confirm(`‚ö†Ô∏è ATEN√á√ÉO!\n\nTem certeza que deseja EXCLUIR o cliente "${nome}"?\n\nEsta a√ß√£o ir√° EXCLUIR PERMANENTEMENTE:\n- O cliente\n- Todos os pedidos vinculados\n- Todas as configura√ß√µes do bot\n- Todas as conversas e mensagens\n\nEsta a√ß√£o N√ÉO PODE SER DESFEITA!`)) return;

            // Confirmar novamente
            if (!confirm(`Confirme novamente: Deseja realmente excluir "${nome}" e TODOS os dados vinculados?`)) return;

            const res = await fetch(`/api/admin/clientes/${id}`, {
                method: 'DELETE'
            });

            if (res.ok) {
                const data = await res.json();
                alert(data.message || 'Cliente exclu√≠do com sucesso!');
                loadClientes();
            } else {
                const error = await res.json();
                alert(error.detail || 'Erro ao excluir cliente');
            }
        }

        // ========== PLANOS ==========
        async function loadPlanos() {
            const res = await fetch('/api/admin/planos');
            const data = await res.json();

            const tbody = document.querySelector('#table-planos tbody');
            tbody.innerHTML = data.map(p => `
                <tr>
                    <td style="text-align:center;">${p.id}</td>
                    <td>${p.nome}</td>
                    <td style="text-align:center;">${p.tipo}</td>
                    <td style="text-align:center;">${p.periodo}</td>
                    <td style="text-align:center;">R$ ${p.preco.toFixed(2).replace(".", ",")}</td>
                    <td style="text-align:center;">${p.link_pagamento ? '‚úÖ Configurado' : '‚ùå Sem link'}</td>
                    <td style="text-align:center;">
                        ${p.link_pagamento ? `<button class="btn-action btn-view" onclick="window.open('${p.link_pagamento}', '_blank')">üîó Abrir Link</button>` : ''}
                        <button class="btn-action btn-edit" onclick="editarPlano(${p.id})">Editar</button>
                        <button class="btn-action btn-delete" onclick="excluirPlano(${p.id})">Excluir</button>
                    </td>
                </tr>
            `).join('');
        }

        function novoPlano() {
            document.getElementById('modal-plano-title').textContent = 'Novo Plano';
            document.getElementById('form-plano').reset();
            document.getElementById('plano-id').value = '';
            openModal('modal-plano');
        }

        async function editarPlano(id) {
            const res = await fetch(`/api/admin/planos/${id}`);
            const data = await res.json();
            const p = data.plano;

            document.getElementById('modal-plano-title').textContent = 'Editar Plano';
            document.getElementById('plano-id').value = p.id;
            document.getElementById('plano-nome').value = p.nome;
            document.getElementById('plano-tipo').value = p.tipo;
            document.getElementById('plano-periodo').value = p.periodo;
            document.getElementById('plano-preco').value = p.preco;
            document.getElementById('plano-link').value = p.link_pagamento || '';
            document.getElementById('plano-descricao').value = p.descricao || '';
            openModal('modal-plano');
        }

        async function salvarPlano(e) {
            e.preventDefault();
            const id = document.getElementById('plano-id').value;
            const data = {
                nome: document.getElementById('plano-nome').value,
                tipo: document.getElementById('plano-tipo').value,
                periodo: document.getElementById('plano-periodo').value,
                preco: parseFloat(document.getElementById('plano-preco').value),
                link_pagamento: document.getElementById('plano-link').value,
                descricao: document.getElementById('plano-descricao').value
            };

            const url = id ? `/api/admin/planos/${id}` : '/api/admin/planos';
            const method = id ? 'PUT' : 'POST';

            const res = await fetch(url, {
                method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            if (res.ok) {
                alert('Plano salvo com sucesso!');
                closeModal('modal-plano');
                loadPlanos();
            } else {
                alert('Erro ao salvar plano');
            }
        }

        async function excluirPlano(id) {
            if (!confirm('Tem certeza que deseja excluir este plano?')) return;

            const res = await fetch(`/api/admin/planos/${id}`, {method: 'DELETE'});

            if (res.ok) {
                const data = await res.json();
                alert(data.message || 'Plano exclu√≠do com sucesso!');
                loadPlanos();
            } else {
                const error = await res.json();
                alert(error.detail || 'Erro ao excluir plano');
            }
        }

        // ========== CONFIGURA√á√ïES DO SISTEMA ==========
        async function carregarConfiguracoes() {
            try {
                const res = await fetch('/api/admin/configuracoes-sistema');
                if (res.ok) {
                    const config = await res.json();
                    console.log('Configura√ß√µes carregadas do banco:', config);

                    // Aguardar um momento para garantir que os elementos estejam renderizados
                    setTimeout(() => {
                        // Evolution API
                        const evolutionUrl = document.getElementById('evolution_api_url');
                        const evolutionKey = document.getElementById('evolution_api_key');
                        if (evolutionUrl) evolutionUrl.value = config.evolution_api_url || '';
                        if (evolutionKey) evolutionKey.value = config.evolution_api_key || '';

                        // Ollama
                        const ollamaUrl = document.getElementById('ollama_url');
                        const ollamaModel = document.getElementById('ollama_model');
                        const ollamaEmbeddings = document.getElementById('ollama_embeddings_model');
                        if (ollamaUrl) ollamaUrl.value = config.ollama_url || 'http://localhost:11434';
                        if (ollamaModel) ollamaModel.value = config.ollama_model || 'llama3';
                        if (ollamaEmbeddings) ollamaEmbeddings.value = config.ollama_embeddings_model || 'nomic-embed-text';

                        // Qdrant
                        const qdrantUrl = document.getElementById('qdrant_url');
                        const qdrantKey = document.getElementById('qdrant_api_key');
                        const qdrantCollection = document.getElementById('qdrant_collection');
                        if (qdrantUrl) qdrantUrl.value = config.qdrant_url || 'http://localhost:6333';
                        if (qdrantKey) qdrantKey.value = config.qdrant_api_key || '';
                        if (qdrantCollection) qdrantCollection.value = config.qdrant_collection || 'kairix';

                        // RAG Config
                        const ragChunkSize = document.getElementById('rag_chunk_size');
                        const ragChunkOverlap = document.getElementById('rag_chunk_overlap');
                        const ragSearchLimit = document.getElementById('rag_search_limit');
                        const ragNumPredict = document.getElementById('rag_num_predict');
                        const ragTemperature = document.getElementById('rag_temperature');
                        const ragTopP = document.getElementById('rag_top_p');
                        if (ragChunkSize) ragChunkSize.value = config.rag_chunk_size || 1500;
                        if (ragChunkOverlap) ragChunkOverlap.value = config.rag_chunk_overlap || 200;
                        if (ragSearchLimit) ragSearchLimit.value = config.rag_search_limit || 5;
                        if (ragNumPredict) ragNumPredict.value = config.rag_num_predict || 800;
                        if (ragTemperature) ragTemperature.value = config.rag_temperature || 0.6;
                        if (ragTopP) ragTopP.value = config.rag_top_p || 0.9;

                        console.log('‚úÖ Campos preenchidos com sucesso!');
                    }, 100);
                } else {
                    alert('Erro ao carregar configura√ß√µes');
                }
            } catch (error) {
                console.error('Erro ao carregar configura√ß√µes:', error);
                alert('Erro ao carregar configura√ß√µes');
            }
        }

        async function salvarConfiguracoes(event) {
            event.preventDefault();

            const config = {
                // Evolution API
                evolution_api_url: document.getElementById('evolution_api_url').value,
                evolution_api_key: document.getElementById('evolution_api_key').value,

                // Ollama
                ollama_url: document.getElementById('ollama_url').value,
                ollama_model: document.getElementById('ollama_model').value,
                ollama_embeddings_model: document.getElementById('ollama_embeddings_model').value,

                // Qdrant
                qdrant_url: document.getElementById('qdrant_url').value,
                qdrant_api_key: document.getElementById('qdrant_api_key').value || null,
                qdrant_collection: document.getElementById('qdrant_collection').value,

                // RAG Config
                rag_chunk_size: parseInt(document.getElementById('rag_chunk_size').value) || 1500,
                rag_chunk_overlap: parseInt(document.getElementById('rag_chunk_overlap').value) || 200,
                rag_search_limit: parseInt(document.getElementById('rag_search_limit').value) || 5,
                rag_num_predict: parseInt(document.getElementById('rag_num_predict').value) || 800,
                rag_temperature: parseFloat(document.getElementById('rag_temperature').value) || 0.6,
                rag_top_p: parseFloat(document.getElementById('rag_top_p').value) || 0.9
            };

            try {
                const res = await fetch('/api/admin/configuracoes-sistema', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                if (res.ok) {
                    alert('‚úÖ Configura√ß√µes salvas com sucesso!');
                } else {
                    const error = await res.json();
                    alert('Erro ao salvar configura√ß√µes: ' + (error.detail || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao salvar configura√ß√µes:', error);
                alert('Erro ao salvar configura√ß√µes');
            }
        }

        // ========== TESTES DE CONEX√ÉO ==========
        async function testarEvolution() {
            const url = document.getElementById('evolution_api_url').value;
            const apiKey = document.getElementById('evolution_api_key').value;
            const resultDiv = document.getElementById('evolution-test-result');

            if (!url || !apiKey) {
                resultDiv.innerHTML = '<div style="background: rgba(255,152,0,0.2); padding: 10px; border-radius: 8px; color: #FF9800; font-size: 13px;">‚ö†Ô∏è Preencha a URL e API Key antes de testar</div>';
                return;
            }

            resultDiv.innerHTML = '<div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; color: #fff; font-size: 13px;">‚è≥ Testando conex√£o...</div>';

            try {
                const res = await fetch('/api/admin/testar-evolution', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, api_key: apiKey })
                });

                const result = await res.json();

                if (result.success) {
                    resultDiv.innerHTML = `<div style="background: rgba(76,175,80,0.2); padding: 10px; border-radius: 8px; color: #4CAF50; font-size: 13px;">
                        ‚úÖ ${result.message}<br>
                        <span style="font-size: 11px; opacity: 0.8;">${result.details}</span>
                    </div>`;
                } else {
                    resultDiv.innerHTML = `<div style="background: rgba(244,67,54,0.2); padding: 10px; border-radius: 8px; color: #f44336; font-size: 13px;">
                        ‚ùå ${result.message}<br>
                        <span style="font-size: 11px; opacity: 0.8;">${result.details}</span>
                    </div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div style="background: rgba(244,67,54,0.2); padding: 10px; border-radius: 8px; color: #f44336; font-size: 13px;">
                    ‚ùå Erro ao testar: ${error.message}
                </div>`;
            }
        }

        async function testarOllama() {
            const url = document.getElementById('ollama_url').value;
            const model = document.getElementById('ollama_model').value;
            const embeddingsModel = document.getElementById('ollama_embeddings_model').value;
            const resultDiv = document.getElementById('ollama-test-result');

            if (!url || !model) {
                resultDiv.innerHTML = '<div style="background: rgba(255,152,0,0.2); padding: 10px; border-radius: 8px; color: #FF9800; font-size: 13px;">‚ö†Ô∏è Preencha a URL e Modelo antes de testar</div>';
                return;
            }

            resultDiv.innerHTML = '<div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; color: #fff; font-size: 13px;">‚è≥ Testando conex√£o e modelos...</div>';

            try {
                // Testar modelo de chat
                const resChat = await fetch('/api/admin/testar-ollama', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, model })
                });
                const resultChat = await resChat.json();

                // Testar modelo de embeddings (se preenchido)
                let resultEmbed = { success: true, message: 'N√£o configurado' };
                if (embeddingsModel) {
                    const resEmbed = await fetch('/api/admin/testar-ollama', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url, model: embeddingsModel })
                    });
                    resultEmbed = await resEmbed.json();
                }

                // Exibir resultados
                let html = '';

                if (resultChat.success) {
                    html += `<div style="background: rgba(76,175,80,0.2); padding: 10px; border-radius: 8px; color: #4CAF50; font-size: 13px; margin-bottom: 8px;">
                        ‚úÖ <strong>Modelo Chat:</strong> ${resultChat.message}<br>
                        <span style="font-size: 11px; opacity: 0.8;">${resultChat.details}</span>
                    </div>`;
                } else {
                    html += `<div style="background: rgba(244,67,54,0.2); padding: 10px; border-radius: 8px; color: #f44336; font-size: 13px; margin-bottom: 8px;">
                        ‚ùå <strong>Modelo Chat:</strong> ${resultChat.message}<br>
                        <span style="font-size: 11px; opacity: 0.8;">${resultChat.details}</span>
                    </div>`;
                }

                if (embeddingsModel) {
                    if (resultEmbed.success) {
                        html += `<div style="background: rgba(76,175,80,0.2); padding: 10px; border-radius: 8px; color: #4CAF50; font-size: 13px;">
                            ‚úÖ <strong>Modelo Embeddings:</strong> ${resultEmbed.message}<br>
                            <span style="font-size: 11px; opacity: 0.8;">${resultEmbed.details}</span>
                        </div>`;
                    } else {
                        html += `<div style="background: rgba(244,67,54,0.2); padding: 10px; border-radius: 8px; color: #f44336; font-size: 13px;">
                            ‚ùå <strong>Modelo Embeddings:</strong> ${resultEmbed.message}<br>
                            <span style="font-size: 11px; opacity: 0.8;">${resultEmbed.details}</span>
                        </div>`;
                    }
                }

                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div style="background: rgba(244,67,54,0.2); padding: 10px; border-radius: 8px; color: #f44336; font-size: 13px;">
                    ‚ùå Erro ao testar: ${error.message}
                </div>`;
            }
        }

        async function testarQdrant() {
            const url = document.getElementById('qdrant_url').value;
            const apiKey = document.getElementById('qdrant_api_key').value;
            const collection = document.getElementById('qdrant_collection').value;
            const resultDiv = document.getElementById('qdrant-test-result');

            if (!url || !collection) {
                resultDiv.innerHTML = '<div style="background: rgba(255,152,0,0.2); padding: 10px; border-radius: 8px; color: #FF9800; font-size: 13px;">‚ö†Ô∏è Preencha a URL e Cole√ß√£o antes de testar</div>';
                return;
            }

            resultDiv.innerHTML = '<div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; color: #fff; font-size: 13px;">‚è≥ Testando conex√£o...</div>';

            try {
                const res = await fetch('/api/admin/testar-qdrant', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, api_key: apiKey || null, collection })
                });

                const result = await res.json();

                if (result.success) {
                    resultDiv.innerHTML = `<div style="background: rgba(76,175,80,0.2); padding: 10px; border-radius: 8px; color: #4CAF50; font-size: 13px;">
                        ‚úÖ ${result.message}<br>
                        <span style="font-size: 11px; opacity: 0.8;">${result.details}</span>
                    </div>`;
                } else {
                    resultDiv.innerHTML = `<div style="background: rgba(244,67,54,0.2); padding: 10px; border-radius: 8px; color: #f44336; font-size: 13px;">
                        ‚ùå ${result.message}<br>
                        <span style="font-size: 11px; opacity: 0.8;">${result.details}</span>
                    </div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div style="background: rgba(244,67,54,0.2); padding: 10px; border-radius: 8px; color: #f44336; font-size: 13px;">
                    ‚ùå Erro ao testar: ${error.message}
                </div>`;
            }
        }

        // ========== UTILS ==========
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');

            if (tab === 'clientes') loadClientes();
            if (tab === 'planos') loadPlanos();
            if (tab === 'configuracoes') carregarConfiguracoes();
        }

        function switchSubTab(subTab) {
            // Remover active de todas as sub-tabs e sub-tab-contents
            document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));

            // Adicionar active na sub-tab clicada e no conte√∫do correspondente
            event.target.classList.add('active');
            document.getElementById(subTab).classList.add('active');
        }

        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/admin/login';
        }

        loadDashboard();
    </script>
</body>
</html>
