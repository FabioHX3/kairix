{% extends "base.html" %}

{% block title %}Atendentes - Kairix{% endblock %}

{% block content %}
<div class="content-header">
    <h1>üë§ Gerenciar Atendentes</h1>
    <p>Configure os n√∫meros que receber√£o notifica√ß√µes de atendimento</p>
</div>

<div class="section-card">
    <h3>Adicionar Atendente</h3>
    <form id="form-atendente">
        <div class="form-group">
            <label>N√∫mero do WhatsApp *</label>
            <input type="text" id="numero-atendente" placeholder="Ex: 5511987654321" required>
            <small>Digite apenas n√∫meros (c√≥digo do pa√≠s + DDD + n√∫mero)</small>
        </div>
        <button type="submit" class="btn btn-success">‚ûï Adicionar Atendente</button>
    </form>
</div>

<div class="section-card" style="margin-top: 20px;">
    <h3>üë• Atendentes Cadastrados</h3>

    <div id="atendentes-list">
        <div class="empty-state">
            <div class="empty-state-icon">üë§</div>
            <p>Nenhum atendente cadastrado</p>
            <p style="font-size: 0.9rem;">Adicione n√∫meros para receber notifica√ß√µes</p>
        </div>
    </div>
</div>

<div class="section-card" style="margin-top: 20px;">
    <h3>‚ÑπÔ∏è Como Funciona</h3>
    <ul style="color: rgba(255,255,255,0.7); line-height: 1.8;">
        <li>Quando um cliente digitar palavras como "atendente", "falar com humano", etc., o bot transferir√°</li>
        <li>Todos os atendentes cadastrados receber√£o uma notifica√ß√£o no WhatsApp</li>
        <li>O atendente pode responder diretamente para o n√∫mero do cliente</li>
        <li>M√∫ltiplos atendentes podem ser cadastrados para melhor cobertura</li>
    </ul>
</div>
{% endblock %}

{% block extra_js %}
<script>
// v1.1 - Corrigido redeclara√ß√£o de vari√°vel
// currentPedidoId j√° declarado em common.js
currentPedidoId = null;

document.addEventListener('DOMContentLoaded', async function() {
    // Buscar pedido ID do cliente
    try {
        const response = await fetch('/api/orders/me', { credentials: 'include' });
        if (response.ok) {
            const orders = await response.json();
            if (orders && orders.length > 0) {
                currentPedidoId = orders[0].id;
                loadAtendentes();
            }
        }
    } catch (error) {
        console.error('Erro ao buscar pedido:', error);
    }
});

// Carregar lista de atendentes
async function loadAtendentes() {
    if (!currentPedidoId) return;

    const container = document.getElementById('atendentes-list');

    try {
        const response = await fetch(`/api/config/${currentPedidoId}/atendentes`, {
            credentials: 'include'
        });

        if (response.ok) {
            const atendentes = await response.json();

            if (!atendentes || atendentes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë§</div>
                        <p>Nenhum atendente cadastrado</p>
                        <p style="font-size: 0.9rem;">Adicione n√∫meros para receber notifica√ß√µes</p>
                    </div>
                `;
                return;
            }

            let html = '';
            atendentes.forEach(atendente => {
                html += `
                    <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600;">üì± ${atendente.numero}</div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.6);">
                                WhatsApp Ativo
                            </div>
                        </div>
                        <button class="btn btn-danger" onclick="removeAtendente('${atendente.numero}')" style="padding: 8px 16px;">üóëÔ∏è Remover</button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }
    } catch (error) {
        console.error('Erro ao carregar atendentes:', error);
    }
}

// Adicionar atendente
document.getElementById('form-atendente').addEventListener('submit', async function(e) {
    e.preventDefault();

    if (!currentPedidoId) {
        alert('Erro: Pedido n√£o encontrado');
        return;
    }

    const numeroInput = document.getElementById('numero-atendente');
    const numero = numeroInput.value.trim();

    if (!numero) {
        alert('Digite um n√∫mero v√°lido');
        return;
    }

    try {
        const response = await fetch(`/api/config/${currentPedidoId}/atendentes`, {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ numero: numero })
        });

        if (response.ok) {
            alert('‚úÖ Atendente adicionado com sucesso!');
            numeroInput.value = '';
            loadAtendentes();
        } else {
            const error = await response.json();
            alert(`Erro: ${error.detail || 'Falha ao adicionar atendente'}`);
        }
    } catch (error) {
        console.error('Erro ao adicionar atendente:', error);
        alert('Erro ao adicionar atendente');
    }
});

// Remover atendente
async function removeAtendente(numero) {
    if (!confirm(`Deseja realmente remover o atendente ${numero}?`)) return;

    try {
        const response = await fetch(`/api/config/${currentPedidoId}/atendentes/${numero}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (response.ok) {
            alert('‚úÖ Atendente removido!');
            loadAtendentes();
        } else {
            alert('Erro ao remover atendente');
        }
    } catch (error) {
        console.error('Erro ao remover:', error);
        alert('Erro ao remover atendente');
    }
}
</script>
{% endblock %}
